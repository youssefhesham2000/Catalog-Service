// Prisma Schema for Product Catalog Search API
// Database: PostgreSQL 18

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Product category with hierarchical support
model Category {
  id        String    @id @default(uuid())
  name      String
  parentId  String?   @map("parent_id")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([parentId])
  @@map("categories")
}

/// Product - the parent entity for variants
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  brand       String?
  categoryId  String   @map("category_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  category Category  @relation(fields: [categoryId], references: [id])
  variants Variant[]

  @@index([categoryId])
  @@index([brand])
  @@map("products")
}

/// Variant - specific combination of product attributes (e.g., Red/Small/V-Neck)
model Variant {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  sku        String   @unique
  attributes Json     @default("{}")
  imageUrl   String?  @map("image_url")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  offers       Offer[]
  sales        VariantSales?

  @@index([productId])
  @@map("variants")
}

/// Supplier - entity that sells products
model Supplier {
  id        String   @id @default(uuid())
  name      String
  rating    Float?   @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  offers Offer[]

  @@map("suppliers")
}

/// Offer - a supplier's listing for a specific variant (price, stock, etc.)
model Offer {
  id         String   @id @default(uuid())
  variantId  String   @map("variant_id")
  supplierId String   @map("supplier_id")
  price      Decimal  @db.Decimal(10, 2)
  stock      Int      @default(0)
  isActive   Boolean  @default(true) @map("is_active")
  version    Int      @default(1)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  variant  Variant      @relation(fields: [variantId], references: [id], onDelete: Cascade)
  supplier Supplier     @relation(fields: [supplierId], references: [id])
  sales    OfferSales?

  @@unique([variantId, supplierId])
  @@index([supplierId])
  @@index([variantId])
  @@map("offers")
}

/// SalesEvent - individual sale transaction (append-only)
model SalesEvent {
  id        String   @id @default(uuid())
  offerId   String   @map("offer_id")
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  soldAt    DateTime @default(now()) @map("sold_at")

  @@index([offerId])
  @@index([soldAt])
  @@map("sales_events")
}

/// OfferSales - aggregated sales for an offer (rolling 30-day window)
model OfferSales {
  id        String   @id @default(uuid())
  offerId   String   @unique @map("offer_id")
  sales30d  Int      @default(0) @map("sales_30d")
  version   Int      @default(1)
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@map("offer_sales")
}

/// VariantSales - aggregated sales for a variant across all offers (for ES ranking)
model VariantSales {
  id        String   @id @default(uuid())
  variantId String   @unique @map("variant_id")
  sales30d  Int      @default(0) @map("sales_30d")
  version   Int      @default(1)
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  variant Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("variant_sales")
}

/// OutboxEvent - transactional outbox for eventual consistency with ES
model OutboxEvent {
  id          String    @id @default(uuid())
  entityType  String    @map("entity_type")
  entityId    String    @map("entity_id")
  operation   String    // INSERT, UPDATE, DELETE
  payload     Json
  status      String    @default("PENDING") // PENDING, PROCESSED, FAILED
  retryCount  Int       @default(0) @map("retry_count")
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@index([status, createdAt])
  @@index([entityType, entityId])
  @@map("outbox_events")
}

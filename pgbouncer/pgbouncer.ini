;; PgBouncer Configuration
;; Connection pooler for PostgreSQL
;; Version: Compatible with PgBouncer 1.23.x+

[databases]
; Database connection - connects to PostgreSQL
; Format: dbname = host=<host> port=<port> dbname=<db>
product_catalog = host=postgres port=5432 dbname=product_catalog

[pgbouncer]
;; Connection settings
listen_addr = 0.0.0.0
listen_port = 6432

;; Authentication
; md5 - uses userlist.txt with md5 hashed passwords
; trust - no password validation (for development only)
; scram-sha-256 - most secure (requires PostgreSQL 10+)
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Pool mode (IMPORTANT for web applications)
; transaction - connection returned after each transaction (recommended)
; session - connection held until client disconnects
; statement - connection returned after each statement
pool_mode = transaction

;; Pool sizing
; default_pool_size: server connections per user/database pair
; min_pool_size: minimum idle connections to keep
; reserve_pool_size: extra connections for burst traffic
; max_client_conn: max simultaneous client connections
; max_db_connections: max connections to PostgreSQL (across all pools)
; For 15 API replicas with connection_limit=5: 15 Ã— 5 = 75 client connections
; Set max_client_conn to 100 for headroom
default_pool_size = 25
min_pool_size = 10
reserve_pool_size = 5
reserve_pool_timeout = 3
max_client_conn = 100
max_db_connections = 50

;; Timeouts (in seconds)
server_connect_timeout = 5
server_idle_timeout = 600
server_lifetime = 3600
client_idle_timeout = 0
client_login_timeout = 60
query_timeout = 30
query_wait_timeout = 60

;; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
stats_period = 60

;; Admin console (for monitoring via SHOW commands)
admin_users = postgres
stats_users = postgres

;; Security - IMPORTANT for Prisma/ORM compatibility
; Prisma sends these startup parameters which PgBouncer doesn't support in transaction mode
; extra_float_digits: PostgreSQL numeric precision parameter
; search_path: Prisma schema parameter
ignore_startup_parameters = extra_float_digits,search_path

;; TCP keepalive (prevent idle connection drops)
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

;; DNS settings
dns_max_ttl = 15
dns_nxdomain_ttl = 15

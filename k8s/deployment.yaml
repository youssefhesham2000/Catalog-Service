# Search API Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: search-api
  namespace: bosta-search
  labels:
    app: search-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: search-api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: search-api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      terminationGracePeriodSeconds: 30
      serviceAccountName: search-api
      
      initContainers:
        # Wait for OpenSearch and create index
        - name: init-opensearch
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for OpenSearch..."
              until curl -s http://opensearch-service:9200/_cluster/health | grep -q '"status":"green"\|"status":"yellow"'; do
                echo "OpenSearch not ready, waiting..."
                sleep 5
              done
              echo "OpenSearch is ready!"
              
              # Check if index exists
              if curl -s -o /dev/null -w "%{http_code}" http://opensearch-service:9200/variants | grep -q "200"; then
                echo "Index 'variants' already exists"
              else
                echo "Creating 'variants' index..."
                curl -X PUT "http://opensearch-service:9200/variants" \
                  -H "Content-Type: application/json" \
                  -d '{
                    "settings": {
                      "number_of_shards": 3,
                      "number_of_replicas": 1,
                      "analysis": {
                        "analyzer": {
                          "product_analyzer": {
                            "type": "custom",
                            "tokenizer": "standard",
                            "filter": ["lowercase", "asciifolding"]
                          }
                        }
                      }
                    },
                    "mappings": {
                      "properties": {
                        "variantId": { "type": "keyword" },
                        "productId": { "type": "keyword" },
                        "sku": { "type": "keyword" },
                        "productName": {
                          "type": "text",
                          "analyzer": "product_analyzer",
                          "fields": { "keyword": { "type": "keyword" } }
                        },
                        "productDescription": { "type": "text" },
                        "brand": {
                          "type": "text",
                          "fields": { "keyword": { "type": "keyword" } }
                        },
                        "categoryId": { "type": "keyword" },
                        "categoryName": {
                          "type": "text",
                          "fields": { "keyword": { "type": "keyword" } }
                        },
                        "attributes": {
                          "type": "object",
                          "dynamic": true,
                          "properties": {
                            "color": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
                            "size": { "type": "text", "fields": { "keyword": { "type": "keyword" } } }
                          }
                        },
                        "imageUrl": { "type": "keyword", "index": false },
                        "priceFrom": { "type": "float" },
                        "totalStock": { "type": "integer" },
                        "sales30d": { "type": "integer" },
                        "offers": {
                          "type": "nested",
                          "properties": {
                            "offerId": { "type": "keyword" },
                            "supplierId": { "type": "keyword" },
                            "supplierName": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
                            "supplierRating": { "type": "float" },
                            "price": { "type": "float" },
                            "stock": { "type": "integer" }
                          }
                        },
                        "createdAt": { "type": "date" },
                        "updatedAt": { "type": "date" }
                      },
                      "dynamic_templates": [
                        {
                          "attributes_as_keyword": {
                            "path_match": "attributes.*",
                            "mapping": { "type": "text", "fields": { "keyword": { "type": "keyword" } } }
                          }
                        }
                      ]
                    }
                  }'
                echo ""
                echo "Index created!"
              fi
              
              # Verify
              curl -s http://opensearch-service:9200/variants | head -c 200
              echo ""
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
      
      containers:
        - name: search-api
          image: bosta/search-api:latest
          imagePullPolicy: IfNotPresent  # Use local image in Kind
          ports:
            - containerPort: 3000
              protocol: TCP
              name: http
          
          envFrom:
            - configMapRef:
                name: search-api-config
            - secretRef:
                name: search-api-secrets
          
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "1000m"
          
          # Readiness probe - only receive traffic when ready
          readinessProbe:
            httpGet:
              path: /api/v1/health/ready  # Health check endpoint
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
          
          # Liveness probe - restart if unhealthy
          livenessProbe:
            tcpSocket:
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          
          # Startup probe - give time for initial startup
          startupProbe:
            tcpSocket:
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 30  # 30 * 5s = 150s max startup time
          
          # Graceful shutdown
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 10"]
          
          volumeMounts:
            - name: logs
              mountPath: /app/logs
      
      volumes:
        - name: logs
          emptyDir: {}
      
      # Spread pods across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: search-api
                topologyKey: kubernetes.io/hostname
      
      # Tolerate node issues briefly
      tolerations:
        - key: "node.kubernetes.io/not-ready"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 30
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 30
---
# Service Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: search-api
  namespace: bosta-search
  labels:
    app: search-api
